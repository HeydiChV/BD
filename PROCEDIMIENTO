ALTER PROCEDURE [dbo].[pd_crear_matricula]
	@id_alumno INT,
	@ids_cursos NVARCHAR(MAX),
	@id_periodo INT,
	@id_matricula_out INT OUTPUT,
	@mensaje NVARCHAR(100) OUTPUT,
	@error INT OUTPUT
AS
BEGIN
	BEGIN TRY
	BEGIN TRANSACTION;

	SET @mensaje = '';
	SET @error = 0;

	--VALIDAR LOS IDs
	-- Validar id_alumno
	IF NOT EXISTS (SELECT * FROM alumnos WHERE id_alumno = @id_alumno)
	BEGIN 
		SET @mensaje = 'El alumno no existe';
		SET @error = 1;
		THROW 51001, @mensaje, 17;
	END;

	-- Validar ids_cursos
	 DECLARE @CursosNoExistentes TABLE (id_curso INT);

        INSERT INTO @CursosNoExistentes (id_curso)
        SELECT value
        FROM string_split(@ids_cursos, ',') s
        WHERE NOT EXISTS (SELECT 1 FROM cursos WHERE id_curso = s.value);

        IF EXISTS (SELECT 1 FROM @CursosNoExistentes)
        BEGIN
            SET @mensaje = 'Uno o más cursos no existen';
            SET @error = 1;
            THROW 51002, @mensaje, 17;
        END;

	-- Validar id_periodo
	IF NOT EXISTS (SELECT * FROM periodo_academico WHERE id_periodo = @id_periodo)
	BEGIN 
		SET @mensaje = 'El periodo académico no existe';
		SET @error = 1;
		THROW 51003, @mensaje, 17;
	END;
